/*! angular-narrative-api 2015-07-23 */
function NarrativeApiProvider(){"use strict";this.defaults={auth:null};var a,b=this.defaults;a=function(a,c){return function(d){function e(b){return angular.extend(b,{positions:a.ArrayFactory(d.auth,b.getPath()+"positions/").create(),photos:a.ArrayFactory(d.auth,b.getPath()+"photos/").create()})}var f={};return d=angular.extend(b,d),d.auth||(d.auth=c()),f.moments=a.ArrayFactory(d.auth,"moments/").itemTransform(e).create(),f.moment=a.ItemFactory(d.auth,"moments/:uuid").transform(e).create(),f.photos=a.ArrayFactory(d.auth,"photos/").create(),f.user=a.ItemFactory(d.auth,"users/:uuid/").create(),f.me=function(a){return f.user("me",a)},f}},a.$inject=["api.narrative.Resource","NarrativeAuth"],this.$get=a}!function(){"use strict";Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e})}(),function(){"use strict";angular.module("api.narrative",[])}(),function(a,b,c){"use strict";function d(){this.keySerializer=function(a,b){return"narrative."+a+"."+b};var a,b=this.keySerializer;a={initialize:function(a,b){this.name=a,this.$cache=b},put:function(a,c){return j.setItem(b(this.name,a),f(c)),this.$cache.put(a,c)},get:function(a){var d=this.$cache.get(a);return d||(d=g(j.getItem(b(this.name,a))),d&&this.$cache.put(a,d)),null===d?c:d},remove:function(a){var c=this.get(a);return j.removeItem(b(this.name,a)),this.$cache.remove(a),c},removeAll:function(){var a=b(this.name,"");return h(j,function(b,c){0===c.indexOf(a)&&j.removeItem(c)}),this.$cache.removeAll()}},this.$get=["$cacheFactory",function(b){var c={};return i(j)?b:function(d){var f=c[d];return f||(f=e(a),f.initialize(d,b(d)),c[d]=f),f}}]}var e=b.copy,f=b.toJson,g=b.fromJson,h=b.forEach,i=b.isUndefined,j=a.localStorage;b.module("api.narrative").provider("NarrativeCache",d)}(window,window.angular),function(a,b,c){"use strict";function d(){function a(a,b){return a.proxy+a.baseUrl+a.apiSuffix+b}function b(a,b){return b.replace(a.baseUrl+a.apiSuffix,"")}this.defaults={api:{proxy:"",baseUrl:"https://narrativeapp.com/",apiSuffix:"api/v2/"}};var d=this.defaults;this.$get=["$http",function(e){function f(f,h,j,k){i(k)&&(k=j,j=c);var l={method:f,url:a(d.api,h)};return k.isLoggedIn()&&(l.headers=k.authorizationHeaders()),i(j)||(l=g(l,{params:j,paramSerializer:"NarrativeParamSerializer"})),e(l).then(function(a){var c=a.data;return c.next&&(c.next=b(d.api,c.next)),c})}return f}]}function e(){this.$get=function(){return function(a){if(!a)return"";var b=[];return f(a,function(a,c){if(null!==a&&!i(a)){var d=a;j(a)&&(d=h(a)),b.push(encodeURIComponent(c)+"="+encodeURIComponent(d))}}),b.join("&")}}}var f=b.forEach,g=b.extend,h=b.toJson,i=b.isUndefined,j=b.isArray;b.isString,b.module("api.narrative").provider("NarrativeParamSerializer",e).provider("NarrativeRequest",d)}(window,window.angular),function(){"use strict";angular.module("api.narrative").factory("api.narrative.Resource",["NarrativeRequest","$q",function(a,b){var c={setPath:function(a){this.__path=a},setAuth:function(a){this.__auth=a},loaded:function(a){return void 0!==a&&(this.__loaded=a),!!this.__loaded},get:function(){return this.q(),this},transform:function(a){return a(this)}},d={initialize:function(a,b){return this.uuid=a||this.uuid,this.__options=b||{},this},fromObject:function(a,b,c){var d=angular.extend(a,this);return d.__options=b.__options,d.__path=a.url||b.__path,d.__auth=b.__auth,d},getPath:function(){return this.__path.replace(":uuid",this.uuid)},q:function(){var b=this;return a("GET",this.getPath(),this.__options,this.__auth).then(function(a){return angular.extend(b,a)})}},e={initialize:function(a){return this.__options=a||{},this.next=this.__path,this.previous=null,this.results=[],this.itemTransform=this.itemTransform||angular.identity,this},setItemTransform:function(a){return this.itemTransform=a,this},getPath:function(){return this.__path},nextPage:function(){if(null===this.next)throw"No more entries to get";var b=this;return a("GET",b.next,b.results.length?null:b.__options,b.__auth).then(function(a){return b.next=a.next,a.results=a.results.map(function(a){return b.itemTransform(d.fromObject(a,b))}),b.results.push.apply(b.results,a.results),b})},q:function(){return this.nextPage()},forEach:function(a){function c(){f=!0}function d(){for(;e<this.results.length;)if(a(this.results[e],e++,c),f)return void g.reject("Foreach aborted.");null!==this.next?this.nextPage().then(d):g.resolve(h)}var e=0,f=!1,g=b.defer(),h=this;return d(),g.promise}};return{ItemFactory:function(a,b){var e=angular.extend({},d,c);return e.setAuth(a),e.setPath(b),{create:function(){return function(a,b){return e.initialize(a,b)}},transform:function(a){return e.transform(a),this}}},ArrayFactory:function(a,b){var d=angular.extend({},e,c);return d.setAuth(a),d.setPath(b),{create:function(){return function(a){return d.initialize(a)}},itemTransform:function(a){return d.setItemTransform(a),this}}}}}])}(),function(a,b,c){"use strict";function d(a,b){return b+"."+a}function e(){function b(a,b,d,e,h,i){var j,k,l;this.$http=b,this.$q=d,this.$window=e,this.$rootScope=h,a=f(a)?{name:a}:a||{},this._config=g(c,a),j=this.$q.defer(),j.resolve(this),this._initialRequest=j.promise,k=this._config.cacheFactoy,f(k)&&(k=i.get(k)),this._cache=k(this._config.name),this._token=null,l=this._cache.get("token"),l&&this.fromTokenObject(l)}this.defaults={name:"global",cacheFactoy:"NarrativeCache",oauthApplication:{clientID:null,redirectURI:null,clientSecret:null},oauthRoutes:{authorize:"https://narrativeapp.com/oauth2/authorize/",token:"http://localhost:8080/https://narrativeapp.com/oauth2/token/"}};var c=this.defaults;b.prototype={construct:function(){return this._object={getOauthToken:this.getOauthToken.bind(this),oauthAuthorizationCode:this.oauthAuthorizationCode.bind(this),oauthImplicit:this.oauthImplicit.bind(this),oauthClientCredentials:this.oauthClientCredentials.bind(this),oauthRefreshToken:this.oauthRefreshToken.bind(this),isLoggedIn:this.isLoggedIn.bind(this),waitForAuth:this.waitForAuth.bind(this),requireAuth:this.requireAuth.bind(this),token:this.token.bind(this),fromTokenObject:this.fromTokenObject.bind(this),authorizationHeaders:this.authorizationHeaders.bind(this),unauth:this.unauth.bind(this),config:this.config.bind(this)},this._object},config:function(){return this._config},_oauthInitRedirect:function(a,b){var c={config:this._config},d=this._config.oauthApplication;b&&(c.parameters=b),this.$window.location.replace(this._config.oauthRoutes.authorize+"?redirect_uri="+d.redirectURI+"&response_type="+a+"&client_id="+d.clientID+"&state="+encodeURIComponent(h(c)))},getOauthToken:function(b,c){var d=this,e=this.$q.defer();return this._initialRequest=e.promise,this.$http({url:this._config.oauthRoutes.token,method:"POST",params:{grant_type:"authorization_code",code:b,redirect_uri:this._config.oauthApplication.redirectURI,client_id:this._config.oauthApplication.clientID},headers:{Authorization:"Basic "+a.btoa(this._config.oauthApplication.clientID+":"+this._config.oauthApplication.clientSecret)}}).then(function(a){return e.resolve(d.fromTokenObject(a.data)),d})},oauthAuthorizationCode:function(a){this._oauthInitRedirect("code",a)},oauthImplicit:function(a){throw"Implicit Grant flow is not supported yet."},oauthClientCredentials:function(a){throw"Client Credentials Grant flow is not supported yet."},oauthRefreshToken:function(a){throw"Refresh Token Grant flow is not supported yet."},isLoggedIn:function(){return null!==this._token},waitForAuth:function(){var a=this;return this._initialRequest.then(function(){if(a.isLoggedIn())return a;var b=a.$q.defer();return a.$rootScope.$on(d(a._config.name,"onlogin"),function(a,c){b.resolve(c)}),b.promise})},requireAuth:function(){var a=this;return this._initialRequest.then(function(){return a.isLoggedIn()?a:a.$q.reject("AUTH_REQUIRED")})},_validateToken:function(a){return!0},token:function(){return this._token},fromTokenObject:function(a){return this._validateToken(a)?(this._cache&&this._cache.put("token",a),this._token=a,this.$rootScope.$broadcast(d(this._config.name,"onlogin"),this),this):this},authorizationHeaders:function(){return{Authorization:this._token.token_type+" "+this._token.access_token}},unauth:function(){this._cache&&this._cache.removeAll(),this._token=null}},this.$get=["$http","$q","$window","$rootScope","$injector",function(a,d,e,g,h){var i={};return function(j){var k,l=j||{},m=f(l)?l:l.name||c.name;return i.hasOwnProperty(m)||(k=new b(j,a,d,e,g,h),i[m]=k.construct()),i[m]}}]}var f=b.isString,g=b.extend,h=b.toJson,i=b.forEach,j=b.toJson;b.module("api.narrative").provider("NarrativeAuth",e).factory("NarrativeUrlObserverFactory",["NarrativeAuth","$location","$window",function(a,b,c){function d(a){var d=b.absUrl(),e=d.substring(0,d.indexOf("?")),f=d.substring(0,d.lastIndexOf("#")+1),g=[];i(a,function(a,b){g.push(b+"="+a)}),c.location.href=e,g&&(c.location.search=g.join("&")),c.location.hash=f,c.location.replace()}function e(a){delete a.state,b.$$html5?b.search(a).replace():d(a)}return this.locationSearch=function(){var a,c=b.absUrl(),d=c.indexOf("?"),e={};return-1!==d&&(a=c.substring(d+1).split("#")[0],i(a?a.split("&"):[],function(a){var b=a.split("=");e[b[0]]=b[1].replace(/\/+$/,"")})),e},this.locationSearch,function(){var c=b.$$html5?b.search():locationSearch(b.absUrl()),d=null;c.hasOwnProperty("state")&&(d=j(decodeURIComponent(c.state)),c.hasOwnProperty("error")?(a(d.config).unauth(),delete c.error,e(c)):c.hasOwnProperty("code")&&(a(d.config).getOauthToken(c.code,d.parameters),delete c.code,e(c)))}}]).run(["NarrativeUrlObserverFactory",function(a){a()}])}(window,window.angular),angular.module("api.narrative").provider("NarrativeApi",NarrativeApiProvider);